<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Constraint Analysis Debug Viewer</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1, h2 {
            margin-top: 0;
        }
        .constraint-item {
            background: #f9f9f9;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #ddd;
        }
        .constraint-item.satisfied {
            border-left-color: #4caf50;
        }
        .constraint-item.unsatisfied {
            border-left-color: #f44336;
        }
        .muscle-match {
            background: #e3f2fd;
            padding: 5px 10px;
            border-radius: 4px;
            margin: 5px 0;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .error {
            color: #f44336;
            font-weight: bold;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #1976d2;
        }
    </style>
</head>
<body>
    <h1>Constraint Analysis Debug Viewer</h1>
    
    <div class="card">
        <h2>Debug Data Status</h2>
        <div id="status">Loading...</div>
        <button onclick="loadDebugData()">Reload Debug Data</button>
    </div>
    
    <div class="card" id="filters-card" style="display: none;">
        <h2>Applied Filters</h2>
        <div id="filters"></div>
    </div>
    
    <div class="card" id="constraint-card" style="display: none;">
        <h2>Constraint Analysis for Pre-Assigned Exercises</h2>
        <div id="constraint-analysis"></div>
    </div>
    
    <div class="card" id="muscle-mapping-card" style="display: none;">
        <h2>Muscle Mapping Analysis</h2>
        <div id="muscle-mapping"></div>
    </div>
    
    <div class="card" id="included-exercises-card" style="display: none;">
        <h2>Included Exercises</h2>
        <div id="included-exercises"></div>
    </div>

    <script>
        const MUSCLE_MAPPING = {
            'chest': ['chest', 'pectorals', 'pecs'],
            'back': ['back', 'lats', 'rhomboids', 'traps', 'trapezius', 'latissimus', 'latissimus dorsi'],
            'shoulders': ['shoulders', 'deltoids', 'delts'],
            'legs': ['legs', 'quads', 'hamstrings', 'glutes', 'calves', 'quadriceps'],
            'arms': ['arms', 'biceps', 'triceps', 'forearms'],
            'core': ['core', 'abs', 'abdominals', 'obliques']
        };

        function checkMuscleMatch(exerciseMuscle, targetMuscle) {
            const exMuscle = exerciseMuscle?.toLowerCase() || '';
            const target = targetMuscle?.toLowerCase() || '';
            
            // Direct match
            if (exMuscle === target) return true;
            
            // Check mapping
            for (const [category, variations] of Object.entries(MUSCLE_MAPPING)) {
                if (variations.includes(target) && variations.includes(exMuscle)) {
                    return true;
                }
            }
            
            return false;
        }

        async function loadDebugData() {
            const statusEl = document.getElementById('status');
            
            try {
                // Load the enhanced debug data
                const response = await fetch('/enhanced-debug-state.json?' + Date.now());
                const data = await response.json();
                
                statusEl.innerHTML = `<span style="color: #4caf50;">✓ Debug data loaded successfully</span><br>
                    <small>Last updated: ${new Date(data.timestamp).toLocaleString()}</small>`;
                
                // Display filters
                displayFilters(data.filters);
                
                // Display constraint analysis
                displayConstraintAnalysis(data);
                
                // Display muscle mapping analysis
                displayMuscleMappingAnalysis(data);
                
                // Display included exercises
                displayIncludedExercises(data);
                
            } catch (error) {
                statusEl.innerHTML = `<span class="error">✗ Failed to load debug data: ${error.message}</span><br>
                    <small>Make sure enhanced-debug-state.json exists in the root directory</small>`;
            }
        }

        function displayFilters(filters) {
            const card = document.getElementById('filters-card');
            const content = document.getElementById('filters');
            
            card.style.display = 'block';
            content.innerHTML = `
                <p><strong>Client:</strong> ${filters.clientName}</p>
                <p><strong>Muscle Targets:</strong> ${filters.muscleTarget.length > 0 ? filters.muscleTarget.join(', ') : 'None'}</p>
                <p><strong>Included Exercises:</strong> ${filters.includeExercises.join(', ')}</p>
                <p><strong>Session Goal:</strong> ${filters.sessionGoal || 'Not specified'}</p>
            `;
        }

        function displayConstraintAnalysis(data) {
            const card = document.getElementById('constraint-card');
            const content = document.getElementById('constraint-analysis');
            
            card.style.display = 'block';
            
            // Check if we have constraint analysis data
            if (!data.constraintAnalysis || Object.keys(data.constraintAnalysis).length === 0) {
                content.innerHTML = '<p class="error">No constraint analysis data found. The constraintTracker may not be populating data.</p>';
                
                // Manually analyze the included exercises
                if (data.filters.includeExercises.length > 0) {
                    content.innerHTML += '<h3>Manual Analysis of Pre-Assigned Exercises:</h3>';
                    
                    const muscleTargets = data.filters.muscleTarget || [];
                    let muscleTargetMatches = 0;
                    
                    // Find the included exercises in the score breakdowns
                    const includedExerciseDetails = [];
                    data.filters.includeExercises.forEach(exerciseName => {
                        const exercise = Object.entries(data.scoreBreakdowns).find(([id, ex]) => 
                            ex.name === exerciseName
                        );
                        if (exercise) {
                            includedExerciseDetails.push(exercise[1]);
                        }
                    });
                    
                    content.innerHTML += `<p><strong>Pre-assigned exercises found:</strong> ${includedExerciseDetails.length} / ${data.filters.includeExercises.length}</p>`;
                    
                    // For now, we'll show what we know
                    content.innerHTML += `<div class="constraint-item unsatisfied">
                        <strong>muscle target:</strong> 0 / ${muscleTargets.length}
                        <br><small>Note: Exercise muscle data not available in score breakdowns. Need to check exercise database.</small>
                    </div>`;
                }
                return;
            }
            
            // Display actual constraint analysis if available
            content.innerHTML = '<pre>' + JSON.stringify(data.constraintAnalysis, null, 2) + '</pre>';
        }

        function displayMuscleMappingAnalysis(data) {
            const card = document.getElementById('muscle-mapping-card');
            const content = document.getElementById('muscle-mapping');
            
            card.style.display = 'block';
            
            content.innerHTML = '<h3>Muscle Mapping Reference</h3>';
            content.innerHTML += '<p>The system should recognize these muscle variations:</p>';
            
            Object.entries(MUSCLE_MAPPING).forEach(([category, variations]) => {
                content.innerHTML += `<div class="muscle-match">
                    <strong>${category}:</strong> ${variations.join(', ')}
                </div>`;
            });
            
            if (data.filters.muscleTarget.includes('back')) {
                content.innerHTML += `<div class="constraint-item unsatisfied">
                    <strong>Issue:</strong> "back" target should match exercises with "lats" as primary muscle
                </div>`;
            }
        }

        function displayIncludedExercises(data) {
            const card = document.getElementById('included-exercises-card');
            const content = document.getElementById('included-exercises');
            
            card.style.display = 'block';
            
            const includedExercises = data.filters.includeExercises || [];
            content.innerHTML = '<h3>Pre-Assigned Exercises:</h3>';
            
            includedExercises.forEach(exerciseName => {
                const scoreData = Object.values(data.scoreBreakdowns).find(ex => ex.name === exerciseName);
                content.innerHTML += `<div class="constraint-item ${scoreData ? 'satisfied' : 'unsatisfied'}">
                    <strong>${exerciseName}</strong>
                    ${scoreData ? `<br>Score: ${scoreData.finalScore}` : '<br>Not found in scored exercises'}
                </div>`;
            });
        }

        // Load data on page load
        window.addEventListener('load', loadDebugData);
    </script>
</body>
</html>